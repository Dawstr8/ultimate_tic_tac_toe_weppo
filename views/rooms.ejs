<!-- views/rooms.ejs -->
<html>
<meta charset="utf-8" />
<script src="/socket.io/socket.io.js"></script>
<script>
    window.addEventListener('load', function () {
        var socket = io();

        function generateRandomUuid() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        socket.on("connect", () => {
            const CLIENT_UUID = 'uuid';
            let clientUuid = localStorage.getItem(CLIENT_UUID);
            if (!clientUuid) {
                clientUuid = generateRandomUuid();
                localStorage.setItem(CLIENT_UUID, clientUuid);
            }

            socket.emit('connected', clientUuid);
        });

        // joining room
        function addListenersToJoinRoomButtons() {
            var btnJoinRoomGroup = document.getElementsByClassName('btnJoinRoom');
            for (var i = 0; i < btnJoinRoomGroup.length; i++) {
                btnJoinRoomGroup[i].addEventListener('click', function (event) {
                    var roomId = this.getAttribute("data-roomid");
                    socket.emit('join room', roomId);
                });
            }
        };
        addListenersToJoinRoomButtons();
        
        socket.on('redirect', function(destination) {
            window.location.href = destination;
        });

        // creating room
        var btnCreateRoom = document.getElementById('btnCreateRoom');
        btnCreateRoom.addEventListener('click', function () {
            socket.emit('create room');
        });

        socket.on('room created', function(id) {
            console.log('room created');
            var roomsList = document.getElementById('roomsList');
            roomsList.innerHTML += '<li id="roomList__room' + id + '">' +
                                        '<span>' + id + '</span>\n' +
                                        '<button data-roomid="' + id + '" class="btnJoinRoom">Join room</button>' +
                                    '</li>';
            addListenersToJoinRoomButtons();
        });

    });
</script>

<head>
</head>

<body>
    <ul id="roomsList">
        <% for (let id in rooms) { %>
            <li id="roomList__room<%= id %>">
                <span><%- id %></span>
                <button data-roomid="<%= id %>" class="btnJoinRoom">Join room</button>
            </li>
        <% } %>
    </ul>
    <button id='btnCreateRoom'>Create room</button>
</body>

</html>